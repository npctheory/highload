version: '3.9'

services:
  ansible:
    build:
      context: ./ansible
      dockerfile: Dockerfile
    container_name: ansible
    restart: unless-stopped
    networks:
      - pg_net
    volumes:
      - ./ansible/playbooks/:/ansible/playbooks
      - /var/run/docker.sock:/var/run/docker.sock  # Mount Docker socket for Ansible

  pg_master:
    build:
      context: ./db
      dockerfile: Dockerfile
    image: db:local
    container_name: pg_master
    restart: unless-stopped
    environment:
      POSTGRES_DB: user
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "35432:5432"
    networks:
      - pg_net
    volumes:
      - pg_master:/var/lib/postgresql/data
      
  pg_slave:
    image: db:local
    depends_on:
      - pg_master
    container_name: pg_slave
    restart: unless-stopped
    environment:
      POSTGRES_DB: user
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "35434:5432"
    networks:
      - pg_net
    volumes:
      - pg_slave:/var/lib/postgresql/data

volumes:
  pg_master:
  pg_slave:
  pg_asyncslave:
  pgadmin_data:
  prometheus_data:
  grafana_data:

networks:
  pg_net:
    external: true
